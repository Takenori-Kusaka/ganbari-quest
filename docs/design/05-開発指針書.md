# がんばりクエスト 開発指針書

| 項目 | 内容 |
|------|------|
| 版数 | 1.0 |
| 作成日 | 2026-02-19 |
| 作成者 | 日下武紀 |

---

## 1. 文書の目的

開発チーム（Claude Code / GitHub Copilot）が従うべき技術方針・規約を定める。CLAUDE.md / AGENTS.md の詳細版として位置づける。

---

## 2. 開発全体方針

- **モバイルファースト**: タブレット（10インチ）タッチ操作を最適化対象とする
- **APIファースト**: `+server.ts` のAPI設計を先行し、画面はAPIを消費する形で実装
- **型安全**: TypeScript strict を全コードに適用。any 禁止
- **テスト駆動**: サービス層は TDD。画面はスナップショット + E2E

---

## 3. 技術スタック

| レイヤ | 技術 | バージョン |
|--------|------|-----------|
| フレームワーク | SvelteKit | 2.x |
| UIフレームワーク | Svelte | 5.x (Runes) |
| UIコンポーネント | Ark UI Svelte | @ark-ui/svelte 最新 |
| スタイル | Tailwind CSS | 4.x |
| 言語 | TypeScript | 5.x (strict: true) |
| ORM | Drizzle ORM | 最新 |
| データベース | SQLite | better-sqlite3 |
| バリデーション | Zod | 最新 |
| テスト | Vitest + Svelte Testing Library | 最新 |
| E2Eテスト | Playwright | 最新 |
| Lint/Format | Biome | 最新 |
| パッケージマネージャ | npm | 10.x |

---

## 4. アーキテクチャ指針

### レイヤ構成

```
Presentation (src/routes/, $lib/ui/)
    ↓ import
Feature ($lib/features/)
    ↓ import
Domain ($lib/domain/)
    ↓ import
Infrastructure ($lib/server/)
```

**依存方向ルール:**
- 上位レイヤは下位レイヤを import できる
- 下位レイヤは上位レイヤを import してはならない
- `$lib/domain/` は `$lib/server/` を import してはならない

### サーバーサイド処理フロー

```
+server.ts / +page.server.ts
    → Zodでリクエストバリデーション
    → $lib/server/services/ でユースケース実行
    → $lib/server/db/ でデータアクセス
    → レスポンス組み立て
```

---

## 5. コーディング規約

### 命名規則

| 対象 | 規則 | 例 |
|------|------|-----|
| ファイル名（コンポーネント） | PascalCase | `ActivityCard.svelte` |
| ファイル名（ロジック） | kebab-case | `activity-service.ts` |
| ファイル名（Svelte runes） | kebab-case + .svelte.ts | `auth-state.svelte.ts` |
| 変数・関数 | camelCase | `getActivities()` |
| 型・インターフェース | PascalCase | `ActivityLog` |
| 定数 | UPPER_SNAKE_CASE | `MAX_PIN_ATTEMPTS` |
| DBカラム | snake_case | `child_id` |
| APIエンドポイント | kebab-case | `/api/v1/activity-logs` |

### Svelte 5 固有ルール

```svelte
<!-- Good: Svelte 5 runes -->
<script lang="ts">
  let count = $state(0);
  let doubled = $derived(count * 2);

  $effect(() => {
    console.log('count changed:', count);
  });
</script>

<!-- Bad: Svelte 4 の古い書き方 -->
<script lang="ts">
  let count = 0;
  $: doubled = count * 2; // 禁止
</script>
```

### TypeScript ルール

- `any` 型の使用禁止。`unknown` + 型ガード を使用
- 関数の戻り値型は必ず明示
- enum は使わず `as const` + type を使用

```typescript
// Good
const CATEGORIES = ['うんどう', 'べんきょう', 'おてつだい', 'コミュニケーション', 'せいかつ'] as const;
type Category = typeof CATEGORIES[number];

// Bad
enum Category { ... }
```

### インポート順序

```typescript
// 1. svelte/kit系
import { json, error } from '@sveltejs/kit';
// 2. 外部パッケージ
import { z } from 'zod';
// 3. $lib/server (サーバーサイドのみ)
import { activityService } from '$lib/server/services/activity-service';
// 4. $lib/domain
import type { Activity } from '$lib/domain/models/activity';
// 5. $lib/ui
import { Button } from '$lib/ui/components';
```

---

## 6. Git運用

### ブランチ戦略

| ブランチ | 用途 |
|----------|------|
| `main` | 本番稼働コード。直接コミット禁止（設計ドキュメント更新を除く） |
| `feature/XXXX-名前` | 機能開発。チケット番号を接頭辞に付ける |
| `fix/XXXX-名前` | バグ修正 |
| `docs/XXXX-名前` | ドキュメント更新 |

### コミットメッセージ規約

```
<type>: <summary> (#チケット番号)

<body（任意）>
```

| type | 用途 |
|------|------|
| `feat` | 新機能 |
| `fix` | バグ修正 |
| `docs` | ドキュメント |
| `refactor` | リファクタリング |
| `test` | テスト追加・修正 |
| `chore` | ビルド・設定変更 |

### プルリクエストルール

- チケット単位でPRを作成
- Claude Code / GitHub Copilot が作成したPRは人間（日下武紀）がレビュー
- マージ前にビルド＋テスト通過を確認

---

## 7. テスト指針

### テストレベル

| レベル | ツール | 対象 | カバレッジ目標 |
|--------|--------|------|--------------|
| ユニットテスト | Vitest | サービス層、ドメインロジック | 80%以上 |
| コンポーネントテスト | Vitest + STL | UIコンポーネント | 主要コンポーネント |
| E2Eテスト | Playwright | 主要ユースケース | 全UC |

### テストファイル配置

```
tests/
├── unit/
│   ├── services/
│   │   ├── activity-service.test.ts
│   │   ├── point-service.test.ts
│   │   └── status-service.test.ts
│   └── domain/
│       └── models/
├── e2e/
│   ├── child-record-activity.spec.ts
│   ├── child-view-status.spec.ts
│   ├── parent-manage-activities.spec.ts
│   └── parent-convert-points.spec.ts
```

### テストデータ

- テスト用のシードデータを `tests/fixtures/` に配置
- E2Eテストはテスト用DBを使用（本番DBに影響しない）

---

## 8. セキュリティ指針

| 項目 | 指針 |
|------|------|
| PIN | bcrypt (cost factor 10) でハッシュ化。平文保存禁止 |
| Cookie | HTTP-only, SameSite=Strict, Secure=false（LAN内のためHTTP） |
| 入力検証 | 全APIでZodバリデーション必須 |
| SQLインジェクション | Drizzle ORM のパラメータバインディングを使用。生SQL禁止 |
| XSS | Svelteの自動エスケープに依存。`{@html}` 使用禁止 |
| Geminiプロンプト | 子供の本名・住所等の個人情報を含めない |

---

## 9. デプロイ指針

### 環境構成

| 環境 | 用途 | URL |
|------|------|-----|
| Dev | ローカル開発 | http://localhost:5173 |
| Prod | NUCサーバー本番 | http://192.168.68.79:3000 |

### デプロイ手順

```bash
# NUCサーバーにSSH接続
ssh kusaka-server@192.168.68.79

# リポジトリ更新
cd /path/to/ganbari-quest
git pull origin main

# 依存関係更新・ビルド
npm ci
npm run build

# サービス再起動
# (Windows タスクスケジューラ or PM2 で管理)
```

### 自動起動設定

- Node.js アプリを Windows サービス or PM2 で常時起動
- タスクスケジューラで日次バックアップ（git push）を設定

---

## 10. ドキュメント管理

### ドキュメント一覧と保管場所

| ドキュメント | 場所 | 更新タイミング |
|-------------|------|---------------|
| 設計ドキュメント群 | docs/design/ | 設計変更時 |
| チケット | docs/tickets/ | チケット進行に応じて |
| CLAUDE.md | ルート | プロジェクト構成変更時 |
| AGENTS.md | ルート | コマンド・規約変更時 |
| README.md | ルート | マイルストーン達成時 |

### セッション間の継続性

- CLAUDE.md に「コンパクション時に保持すべき情報」を明記
- チケットのステータスで現在の作業位置を追跡
- 各設計書の版数で変更履歴を管理

---

## 11. Claude Code / GitHub Copilot の使い分け

| 担当 | Claude Code | GitHub Copilot |
|------|-------------|----------------|
| 設計ドキュメント作成 | **主担当** | - |
| アーキテクチャ設計 | **主担当** | - |
| 複雑なビジネスロジック | **主担当** | - |
| CRUD API実装 | 設計・レビュー | **実装可能** |
| DBスキーマ定義 | 設計 | **実装可能** |
| UIコンポーネント実装 | 設計・レビュー | **部分的に実装可能** |
| テストコード | 設計 | **実装可能** |
| デプロイ設定 | **主担当** | - |

### GitHub Copilot に渡すチケットの条件

1. 入力となる設計ドキュメント（API仕様、DB設計等）が完成していること
2. AGENTS.md に従うべきルールが明記されていること
3. チケットに具体的なゴール（ファイル名、関数名等）が記載されていること
