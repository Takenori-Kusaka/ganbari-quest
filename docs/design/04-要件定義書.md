# がんばりクエスト 要件定義書

| 項目 | 内容 |
|------|------|
| 版数 | 1.0 |
| 作成日 | 2026-02-19 |
| 作成者 | 日下武紀 |

---

## 1. 文書の目的

要求仕様書（02）およびユースケース設計書（03）を基に、実装レベルの要件を定義する。本文書はUI設計書、API設計書、DB設計書の入力となる。

---

## 2. システム全体像

### システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                    NUCサーバー (Windows)                   │
│                    192.168.68.79                          │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │              Node.js Runtime                     │    │
│  │                                                  │    │
│  │  ┌──────────────────────────────────────────┐   │    │
│  │  │           SvelteKit 2 Application         │   │    │
│  │  │                                           │   │    │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  │   │    │
│  │  │  │ (child) │  │(parent) │  │  api/v1  │  │   │    │
│  │  │  │ routes  │  │ routes  │  │  routes  │  │   │    │
│  │  │  └────┬────┘  └────┬────┘  └────┬────┘  │   │    │
│  │  │       │            │            │         │   │    │
│  │  │  ┌────▼────────────▼────────────▼────┐   │   │    │
│  │  │  │     hooks.server.ts               │   │   │    │
│  │  │  │     (PIN認証ミドルウェア)          │   │   │    │
│  │  │  └───────────────┬───────────────────┘   │   │    │
│  │  │                  │                        │   │    │
│  │  │  ┌───────────────▼───────────────────┐   │   │    │
│  │  │  │      $lib/server/services/        │   │   │    │
│  │  │  │      (ユースケース実装)            │   │   │    │
│  │  │  └───────────────┬───────────────────┘   │   │    │
│  │  │                  │                        │   │    │
│  │  │  ┌───────────────▼───────────────────┐   │   │    │
│  │  │  │      $lib/server/db/              │   │   │    │
│  │  │  │      (Drizzle ORM + SQLite)       │   │   │    │
│  │  │  └───────────────┬───────────────────┘   │   │    │
│  │  └──────────────────│────────────────────────┘   │    │
│  └─────────────────────│────────────────────────────┘    │
│                        │                                  │
│  ┌─────────────────────▼─────────────┐                   │
│  │    ganbari-quest.db (SQLite)      │                   │
│  └───────────────────────────────────┘                   │
│                                                          │
│  ┌───────────────────────────────────┐                   │
│  │    static/images/ (キャラクター)   │                   │
│  └───────────────────────────────────┘                   │
└─────────────────────┬───────────────────────────────────┘
                      │ (Gemini API のみ外部通信)
                ┌─────▼─────┐
                │ Gemini API │
                └───────────┘
```

### 対象プラットフォーム

| 項目 | 要件 |
|------|------|
| サーバーOS | Windows (NUC) |
| ランタイム | Node.js 20 LTS 以上 |
| クライアント | Chrome / Safari / Edge 最新2バージョン |
| 最適化対象 | タブレット（10インチ）タッチ操作 |

---

## 3. 用語定義

| 用語 | 定義 |
|------|------|
| 活動 (Activity) | 子供が行う行為のカテゴリ。「お手伝い」「運動」「勉強」等 |
| 活動ログ (ActivityLog) | 子供が活動を記録した1件のエントリ |
| ポイント (Point) | 活動や評価により付与される仮想通貨。1P = 1円 |
| ステータス (Status) | 子供の能力値。カテゴリ別に数値化される |
| レベル (Level) | ステータス総合値から算出される段階 |
| 偏差値 (DeviationScore) | 一般市場の平均・標準偏差に基づく相対評価値 |
| 週次評価 (WeeklyEvaluation) | 毎週日曜に実行される自動評価処理 |
| 市場ベンチマーク (MarketBenchmark) | 年齢別の一般平均値・標準偏差データ |
| テーマ (Theme) | 子供別のUI色味・デザイン設定 |

---

## 4. 機能要件

### 4.1 画面一覧

| ID | 画面名 | ルートグループ | URL | 概要 |
|----|--------|---------------|-----|------|
| S-01 | 子供ホーム | (child) | / | 活動アイコン一覧。2タップで記録 |
| S-02 | 活動確認 | (child) | /confirm | 活動記録の確認画面 |
| S-03 | 記録完了 | (child) | /complete | 記録完了＋キャンセルボタン |
| S-04 | 活動履歴 | (child) | /history | 今週/今月/今年の活動一覧 |
| S-05 | ステータス | (child) | /status | レベル、ステータスゲージ、キャラクター |
| S-06 | 子供切替 | (child) | /switch | 子供選択画面 |
| S-07 | PIN入力 | (parent) | /admin/login | PIN認証画面 |
| S-08 | 管理ダッシュボード | (parent) | /admin | 管理メニュー |
| S-09 | 活動管理 | (parent) | /admin/activities | 活動CRUD |
| S-10 | ポイント管理 | (parent) | /admin/points | ポイント確認・変換 |
| S-11 | 表示管理 | (parent) | /admin/visibility | 表示/非表示切替 |
| S-12 | 子供ステータス詳細 | (parent) | /admin/children/[id] | 子供の詳細ステータス（親向け） |

### 4.2 機能別詳細要件

#### F-01: 活動記録機能

**画面要件 (S-01 → S-02 → S-03):**

| 項目 | 要件 |
|------|------|
| S-01 ホーム | 活動をカテゴリ別にアイコングリッド表示。1カテゴリ最大12活動。スクロール可 |
| S-02 確認 | 選択した活動のアイコン＋活動名（大きなひらがな）＋「やった！」ボタン＋「もどる」ボタン |
| S-03 完了 | 獲得ポイント表示＋完了アニメーション＋「キャンセル」ボタン（5秒間表示） |

**処理要件:**

| 項目 | 要件 |
|------|------|
| ログ作成 | activity_logs に子供ID、活動ID、日時、ポイントを記録 |
| ポイント付与 | 活動の基本ポイント値をポイント残高に加算 |
| キャンセル | 5秒以内のキャンセルでログ削除＋ポイント取消 |
| 同一活動制限 | 同じ活動を1日に複数回記録可能（回数制限は活動ごとに設定可） |

#### F-02: ステータス表示機能

**画面要件 (S-05):**

| 項目 | 要件 |
|------|------|
| レベル表示 | 大きな数字＋経験値バー |
| ステータスゲージ | カテゴリ別の横棒ゲージ（0-100のビジュアル） |
| キャラクター | ステータスに応じたキャラクター画像表示 |
| 市場比較 | 偏差値を★マーク（5段階）で簡易表示 |

**処理要件:**

| 項目 | 要件 |
|------|------|
| レベル計算 | 全カテゴリのステータス合計値 ÷ カテゴリ数の平均 → レベルテーブル参照 |
| 偏差値計算 | (個人値 - 年齢別平均) ÷ 年齢別標準偏差 × 10 + 50 |
| キャラクター判定 | 偏差値55以上→ヒーロー、45-55→通常、45未満→がんばり中 |

**レベルテーブル（暫定）:**

| レベル | 必要平均ステータス | 称号 |
|--------|------------------|------|
| 1 | 0-9 | はじめのぼうけんしゃ |
| 2 | 10-19 | がんばりルーキー |
| 3 | 20-29 | やるきファイター |
| 4 | 30-39 | つよつよチャレンジャー |
| 5 | 40-49 | すごいヒーロー |
| 6 | 50-59 | でんせつのゆうしゃ |
| 7 | 60-69 | そらとぶチャンピオン |
| 8 | 70-79 | きせきのマスター |
| 9 | 80-89 | せかいいちのつわもの |
| 10 | 90-100 | かみさまレベル |

#### F-03: 週次評価機能

**処理要件:**

| 項目 | 要件 |
|------|------|
| 実行タイミング | 毎週日曜日 0:00 |
| 集計期間 | 月曜0:00 〜 日曜23:59 |
| 評価算出 | カテゴリ別の活動回数・ポイントを集計 |
| ステータス更新 | 活動量に応じてステータス値を増加 |
| ポイント付与 | 評価スコアに応じたボーナスポイントを付与 |
| 結果保存 | evaluations テーブルに評価結果を保存 |

**ステータス増加ロジック（暫定）:**

```
週間活動回数 >= 7回（毎日） → +3.0
週間活動回数 >= 5回         → +2.0
週間活動回数 >= 3回         → +1.0
週間活動回数 >= 1回         → +0.5
週間活動回数 == 0回         → +0.0（減少はUC-11で処理）
```

#### F-04: ステータス自動減少機能

**処理要件:**

| 項目 | 要件 |
|------|------|
| 実行タイミング | 毎日 0:00 |
| 減少計算 | カテゴリ別に最終活動日からの経過日数で計算 |
| 年齢係数 | 0-6歳: 0.3, 7-12歳: 0.5, 13-18歳: 0.7, 19-20歳: 0.9 |
| 基礎減少 | 1日未活動で 年齢係数 × 0.1 |
| 加速減少 | N日連続未活動で 基礎減少 + 0.05 × (N-1) |
| 下限 | ステータス値は0以下にならない |

※ 加速減少の係数（0.05）は運用しながら調整予定

#### F-05: PIN認証機能

**画面要件 (S-07):**

| 項目 | 要件 |
|------|------|
| 入力方法 | 数字パッド（0-9）表示。4-6桁入力 |
| フィードバック | 入力済み桁数をドット表示 |
| エラー | 不一致時「PINがちがいます」表示 |
| ロックアウト | 5回連続失敗で5分間ロック |

**処理要件:**

| 項目 | 要件 |
|------|------|
| PIN保存 | bcrypt でハッシュ化して settings テーブルに保存 |
| セッション | HTTP-only Cookie。30分間有効（操作なしタイムアウト） |
| 初回設定 | PIN未設定時はPIN設定画面を表示 |
| 認証チェック | hooks.server.ts で (parent) グループのルートを保護 |

---

## 5. 非機能要件

### 5.1 性能要件

| 項目 | 目標値 | 備考 |
|------|--------|------|
| 初回ページロード | 3秒以内 | LAN内、タブレット |
| 操作応答時間 | 500ms以内 | タップから画面更新まで |
| API応答時間 | 200ms以内 | サーバー処理時間 |
| 同時接続数 | 5端末 | 家族4名分 + 予備1 |
| DBクエリ時間 | 50ms以内 | 単一テーブルクエリ |

### 5.2 セキュリティ要件

| 項目 | 要件 |
|------|------|
| ネットワーク | LAN内のみアクセス可能（ファイアウォール設定） |
| 管理画面認証 | 4-6桁PINコード（bcryptハッシュ保存） |
| セッション | HTTP-only / SameSite=Strict Cookie |
| Gemini API | プロンプトに個人情報（名前・住所等）を含めない |
| CORS | 同一オリジンのみ許可 |

### 5.3 可用性・バックアップ

| 項目 | 要件 |
|------|------|
| 稼働時間 | NUCサーバー起動中は常時 |
| バックアップ | SQLiteファイルの日次Git push |
| 復旧目標 | 最大24時間分のデータロスまで許容 |
| 復旧手順 | Gitリポジトリからclone → SQLiteファイル配置 → サービス起動 |

### 5.4 運用要件

| 項目 | 要件 |
|------|------|
| ログ | アプリケーションログをファイル出力（日次ローテーション） |
| 監視 | ヘルスチェックエンドポイント `/api/health` |
| 更新 | git pull → npm run build → サービス再起動 |

---

## 6. 外部インターフェース要件

### 6.1 Gemini API

| 項目 | 内容 |
|------|------|
| 用途 | キャラクター画像生成 |
| モデル | gemini-3-pro-image-preview (Nano Banana Pro) |
| 認証 | API Key（.env に保存） |
| リクエスト頻度 | レベルアップ時 or ステータス変化時（最大1日数回） |
| タイムアウト | 30秒 |
| フォールバック | API失敗時はプリセット画像を使用 |

### 6.2 GitHub（バックアップ）

| 項目 | 内容 |
|------|------|
| 用途 | SQLiteファイルのバックアップ |
| 方式 | 日次でgit add + commit + push |
| リポジトリ | プライベートリポジトリ |

---

## 7. データ要件

### 主要エンティティ

| エンティティ | 説明 | 主なカラム |
|-------------|------|-----------|
| children | 子供プロフィール | id, nickname, age, theme, created_at |
| activities | 活動マスタ | id, name, category, icon, base_points, age_min, age_max, is_visible |
| activity_logs | 活動記録 | id, child_id, activity_id, points, recorded_at |
| points | ポイント残高・履歴 | id, child_id, amount, type(earn/spend), description, created_at |
| statuses | ステータス値 | id, child_id, category, value, updated_at |
| evaluations | 週次評価結果 | id, child_id, week_start, scores_json, bonus_points, created_at |
| market_benchmarks | 市場比較データ | id, age, category, mean, std_dev, source, updated_at |
| settings | システム設定 | key, value |
| character_images | キャラクター画像 | id, child_id, type, file_path, generated_at |

### データ保持期間

| データ | 保持期間 | 備考 |
|--------|----------|------|
| 活動ログ | 永久保持 | 成長記録として活用 |
| ポイント履歴 | 永久保持 | お小遣い管理の根拠 |
| ステータス履歴 | 永久保持 | 成長曲線表示に使用 |
| 評価結果 | 永久保持 | 週次レポートの蓄積 |
| キャラクター画像 | 最新10件保持 | 古い画像は自動削除 |

---

## 8. ステータスカテゴリ定義

| カテゴリ | 説明 | 代表的な活動例 |
|----------|------|---------------|
| うんどう | 身体能力・運動習慣 | 体操、外遊び、スイミング |
| べんきょう | 学習・知識・思考力 | ひらがな練習、数字、読み聞かせ |
| おてつだい | 生活スキル・家事参加 | 食器運び、片付け、着替え |
| コミュニケーション | 社会性・対人関係 | 友達を誘う、挨拶、発表 |
| せいかつ | 基本的生活習慣 | 歯磨き、早寝早起き、完食 |

### 初期活動リスト

| 活動名 | カテゴリ | 基本ポイント | 対象年齢 | 備考 |
|--------|----------|-------------|---------|------|
| たいそうした | うんどう | 5 | 全年齢 | |
| おそとであそんだ | うんどう | 5 | 全年齢 | |
| すいみんぐ | うんどう | 10 | 3歳〜 | |
| ひらがなれんしゅう | べんきょう | 5 | 3歳〜 | |
| すうじをかぞえた | べんきょう | 5 | 3歳〜 | |
| えほんをよんだ | べんきょう | 5 | 全年齢 | |
| しょっきをはこんだ | おてつだい | 5 | 3歳〜 | |
| かたづけた | おてつだい | 5 | 全年齢 | |
| おきがえした | せいかつ | 3 | 3歳〜 | |
| はみがきした | せいかつ | 3 | 全年齢 | |
| ともだちとあそんだ | コミュニケーション | 5 | 3歳〜 | |
| あいさつした | コミュニケーション | 3 | 全年齢 | |
| としょかんにいった | べんきょう | 10 | 全年齢 | |
| はっぴょうかいでがんばった | コミュニケーション | 20 | 3歳〜 | 特別イベント |
| ごはんをぜんぶたべた | せいかつ | 3 | 1歳〜6歳 | 年齢で自動非表示 |

---

## 9. 受入条件・検収基準

### MVP 受入条件

| # | 条件 | 検証方法 |
|---|------|----------|
| 1 | お嬢様（4歳）が一人で活動を記録できる | 実機テスト（タブレット） |
| 2 | 2タップ以内で記録が完了する | E2Eテスト |
| 3 | ステータス画面でレベルとキャラクターが表示される | E2Eテスト |
| 4 | 親がPIN認証後に活動を追加できる | E2Eテスト |
| 5 | 500ポイント単位でお小遣い変換できる | ユニットテスト + E2Eテスト |
| 6 | 週次評価が自動実行される | バッチテスト |
| 7 | ステータスが未活動で減少する | ユニットテスト |
| 8 | SQLiteデータがGitHubにバックアップされる | 手動確認 |

---

## 10. リスク・前提条件・課題管理

### 未確定事項

| 項目 | 現状 | 解決方針 |
|------|------|----------|
| 市場比較データ | 具体的なデータソース未定 | ブレストで方法論を確立。初期はハードコード値 |
| ステータス減少の加速係数 | 暫定値（0.05）で設計 | 運用データを基に調整 |
| キャラクターデザイン | Gemini API生成の品質未確認 | プロトタイプで検証。フォールバック画像を準備 |
| レベルテーブル | 暫定定義 | 運用しながらバランス調整 |

### 前提条件

- NUCサーバーにNode.js 20以上がインストール可能
- 家庭内LANでタブレットからサーバーにアクセス可能
- Gemini API の無料枠で画像生成が十分な回数実行可能
