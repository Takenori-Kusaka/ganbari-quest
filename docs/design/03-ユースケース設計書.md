# がんばりクエスト ユースケース設計書

| 項目 | 内容 |
|------|------|
| 版数 | 1.0 |
| 作成日 | 2026-02-19 |
| 作成者 | 日下武紀 |

---

## 1. アクター定義

| アクター | 説明 |
|----------|------|
| 子供 | アプリのメインユーザー。活動記録・履歴確認・ステータス確認を行う |
| 親 | 管理者。活動の追加・ポイント変換・表示/非表示管理を行う |
| システム | 自動処理。週次評価・ステータス減少・年齢別自動非表示を実行 |

---

## 2. ユースケース一覧

```
┌─────────────────────────────────────────────────────┐
│                  がんばりクエスト                      │
│                                                      │
│  ┌──────────┐                      ┌──────────┐     │
│  │          │  UC-01 活動を記録     │          │     │
│  │   子供   │──────────────────────▶│          │     │
│  │          │  UC-13 ログインボーナス│          │     │
│  │          │──────────────────────▶│          │     │
│  │          │  UC-02 記録をキャンセル│          │     │
│  │          │──────────────────────▶│          │     │
│  │          │  UC-03 履歴を確認     │          │     │
│  │          │──────────────────────▶│          │     │
│  │          │  UC-04 ステータス確認 │ システム │     │
│  │          │──────────────────────▶│          │     │
│  │          │  UC-05 子供を切り替え │          │     │
│  │          │──────────────────────▶│          │     │
│  └──────────┘                      │          │     │
│                                    │          │     │
│  ┌──────────┐                      │          │     │
│  │          │  UC-06 活動を追加     │          │     │
│  │   親     │──────────────────────▶│          │     │
│  │(PIN認証) │  UC-07 ポイント変換   │          │     │
│  │          │──────────────────────▶│          │     │
│  │          │  UC-08 表示/非表示    │          │     │
│  │          │──────────────────────▶│          │     │
│  │          │  UC-09 PIN認証        │          │     │
│  │          │──────────────────────▶│          │     │
│  └──────────┘                      │          │     │
│                                    │          │     │
│  ┌──────────┐                      │          │     │
│  │ システム │  UC-10 週次評価       │          │     │
│  │ (自動)   │──────────────────────▶│          │     │
│  │          │  UC-11 ステータス減少 │          │     │
│  │          │──────────────────────▶│          │     │
│  │          │  UC-12 年齢別非表示   │          │     │
│  │          │──────────────────────▶│          │     │
│  └──────────┘                      └──────────┘     │
└─────────────────────────────────────────────────────┘
```

---

## 3. ユースケース詳細

### UC-01: 活動を記録する

| 項目 | 内容 |
|------|------|
| アクター | 子供 |
| 概要 | 子供が行った活動を最大2タップで記録する |
| 事前条件 | 子供用ホーム画面が表示されている |
| 事後条件 | 活動ログが保存され、ポイントが仮付与される。連続記録の場合はストリークボーナスも付与 |

**主フロー:**
1. 子供がホーム画面の活動アイコン一覧を見る（当日記録済みの活動はチェック付きグレーアウト）
2. 該当する活動のアイコンをタップする（1タップ目）
3. 確認画面に活動名（アイコン＋大きな文字）と「やった！」ボタンが表示される
4. 子供が「やった！」ボタンをタップする（2タップ目）
5. 記録完了アニメーション＋獲得ポイント表示（ストリーク中は「○日れんぞく！+□ボーナス」表示）
6. 「キャンセル」ボタンが5秒間表示される
7. 5秒経過後、ホーム画面に戻る

**代替フロー:**
- 3a. 確認画面で「もどる」をタップ → ホーム画面に戻る（記録なし）
- 6a. 「キャンセル」をタップ → UC-02に遷移

**代替フロー（追加）:**
- 2a. 既に当日記録済みの活動はチェックマーク＋グレーアウトで表示（タップ不可）

**例外フロー:**
- E1. サーバーエラー → エラーアイコン表示＋自動リトライ（3回）
- E2. 同日重複記録 → `ALREADY_RECORDED` エラー。「きょうはもうやったよ！」表示

---

### UC-02: 記録をキャンセルする

| 項目 | 内容 |
|------|------|
| アクター | 子供 |
| 概要 | 誤って記録した活動を即座にキャンセルする |
| 事前条件 | UC-01の記録完了後5秒以内 |
| 事後条件 | 活動ログが削除され、仮付与ポイントが取り消される |

**主フロー:**
1. UC-01の記録完了後、「キャンセル」ボタンが表示されている
2. 子供が「キャンセル」ボタンをタップする
3. 「けしました」の確認表示
4. ホーム画面に戻る

**代替フロー:**
- 1a. 5秒経過後 → キャンセルボタン非表示。親が管理画面から削除可能

---

### UC-03: 活動履歴を確認する

| 項目 | 内容 |
|------|------|
| アクター | 子供 |
| 概要 | 過去の活動記録を振り返る |
| 事前条件 | 子供用画面が表示されている |
| 事後条件 | なし（参照のみ） |

**主フロー:**
1. 子供がナビゲーションの「きろく」アイコンをタップ
2. 今週の活動一覧が表示される（アイコン＋日付＋獲得ポイント）
3. 期間切替（今週 / 今月 / 今年）のタブをタップで切替可能

**代替フロー:**
- 2a. 活動がない場合 → 「まだきろくがないよ！」メッセージ＋やる気を促すキャラクター表示

---

### UC-04: ステータスを確認する

| 項目 | 内容 |
|------|------|
| アクター | 子供 |
| 概要 | 現在のステータス値、レベル、キャラクターを確認する |
| 事前条件 | 子供用画面が表示されている |
| 事後条件 | なし（参照のみ） |

**主フロー:**
1. 子供がナビゲーションの「つよさ」アイコンをタップ
2. ステータス画面が表示される
   - レベル表示（大きな数字＋レベルバー）
   - 各ステータス値（運動、勉強、お手伝い等）のビジュアルゲージ
   - 現在のキャラクター表示
   - 一般市場との比較（★マークやメーターで視覚化）
3. キャラクターをタップすると拡大表示＋一言コメント

**代替フロー:**
- 2a. 偏差値55以上の分野がある → その分野にヒーローバッジ表示
- 2b. 偏差値45未満の分野がある → その分野に「がんばり中」マーク＋応援メッセージ

---

### UC-05: 子供を切り替える

| 項目 | 内容 |
|------|------|
| アクター | 子供/親 |
| 概要 | 子供用画面で表示する子供を切り替える |
| 事前条件 | 複数の子供が登録されている |
| 事後条件 | 選択した子供の専用画面に切り替わる |

**主フロー:**
1. 画面上部の子供アイコンをタップ
2. 登録済みの子供一覧（アイコン＋名前）が表示される
3. 切り替えたい子供をタップ
4. 画面テーマ（色味・背景）が切り替わり、選択した子供のデータが表示される

---

### UC-06: 活動を追加する

| 項目 | 内容 |
|------|------|
| アクター | 親 |
| 概要 | 新しい活動カテゴリを追加する |
| 事前条件 | 管理画面にPIN認証済みでログインしている |
| 事後条件 | 新しい活動が子供の画面に反映される |

**主フロー:**
1. 管理画面の「活動管理」を選択
2. 「新規追加」ボタンをタップ
3. 活動情報を入力
   - 活動名（例：「図書館に行った」）
   - カテゴリ（運動/勉強/お手伝い/コミュニケーション/その他）
   - アイコン選択
   - 基本ポイント値
   - 対象年齢範囲（任意）
   - 対象の子供（全員 or 特定の子供）
4. 「保存」ボタンをタップ
5. 活動が追加され、子供の画面に即座に反映

**代替フロー:**
- 3a. 既存の活動と同名 → 重複警告を表示

---

### UC-07: ポイントをお小遣いに変換する

| 項目 | 内容 |
|------|------|
| アクター | 親 |
| 概要 | 子供のポイントをお小遣い（500P単位）に変換する |
| 事前条件 | 管理画面にPIN認証済みでログイン。対象の子供のポイント残高が500以上 |
| 事後条件 | ポイントが500P単位で減少し、変換履歴が記録される |

**主フロー:**
1. 管理画面の「ポイント管理」を選択
2. 子供ごとのポイント残高が表示される
3. 変換したい子供の「変換」ボタンをタップ
4. 変換ポイント数を選択（500 / 1000 / 全額(500P単位切り捨て)）
5. 確認ダイアログ「○○ちゃんの△△ポイントをおこづかいにかえますか？」
6. 「はい」をタップ
7. ポイント減算＋変換履歴記録＋完了メッセージ

**代替フロー:**
- 2a. ポイント残高が500未満 → 「変換」ボタンが非活性。「あと○○ポイント！」表示

**例外フロー:**
- E1. 変換処理中にエラー → ポイントは変更なし。エラーメッセージ表示

---

### UC-08: 活動を表示/非表示にする

| 項目 | 内容 |
|------|------|
| アクター | 親 |
| 概要 | 任意の活動を子供の画面から表示/非表示にする |
| 事前条件 | 管理画面にPIN認証済みでログインしている |
| 事後条件 | 対象活動の表示状態が変更される |

**主フロー:**
1. 管理画面の「活動管理」を選択
2. 活動一覧が表示される（表示中/非表示の状態付き）
3. 対象活動のトグルスイッチを切り替え
4. 即座に子供の画面に反映

---

### UC-09: 管理画面にPIN認証する

| 項目 | 内容 |
|------|------|
| アクター | 親 |
| 概要 | 管理画面にアクセスするためにPINコードを入力する |
| 事前条件 | PINコードが設定済み |
| 事後条件 | 管理画面へのアクセスが許可される |

**主フロー:**
1. 管理画面URLにアクセス or ナビゲーションから「かんりがめん」をタップ
2. PIN入力画面が表示される（数字パッド）
3. PINコード（4〜6桁）を入力
4. 認証成功 → 管理画面ダッシュボード表示

**代替フロー:**
- 3a. PIN不一致 → エラーメッセージ「PINがちがいます」。再入力可能
- 3b. 5回連続失敗 → 5分間ロックアウト

**補足:**
- セッションは30分間有効（操作なし30分でタイムアウト）
- 初回利用時はPIN設定画面を表示

---

### UC-10: 週次評価を実行する

| 項目 | 内容 |
|------|------|
| アクター | システム（自動） |
| 概要 | 週次で子供の活動を評価し、ポイントを付与する |
| 事前条件 | 1週間分の活動ログが存在する |
| 事後条件 | 評価結果が保存され、ポイントが付与される |

**主フロー:**
1. 毎週日曜日の深夜0時にバッチ実行
2. 各子供について1週間の活動ログを集計
3. カテゴリ別の活動量を算出
4. 市場比較データ（偏差値）を参照し、評価スコアを算出
5. 評価スコアに基づきポイントを算出・付与
6. 評価結果をevaluationsテーブルに保存
7. ステータス値を更新

**代替フロー:**
- 2a. 活動ログがゼロの場合 → 評価スコア0、ポイント付与なし

---

### UC-11: ステータスを自動減少させる

| 項目 | 内容 |
|------|------|
| アクター | システム（自動） |
| 概要 | 未活動期間に応じてステータスを自動的に減少させる |
| 事前条件 | なし |
| 事後条件 | ステータス値が更新される |

**主フロー:**
1. 毎日深夜0時にバッチ実行
2. 各子供の各カテゴリについて、最終活動日からの経過日数を計算
3. 経過日数が1日以上の場合:
   - 基礎減少量 = 年齢係数 × カテゴリ基礎値
   - 連続未活動ボーナス = α × max(0, 経過日数 - 1)
   - 合計減少量 = 基礎減少量 + 連続未活動ボーナス
4. ステータス値を減少（下限0）
5. 減少履歴をログに記録

---

### UC-12: 年齢に適さない活動を自動非表示にする

| 項目 | 内容 |
|------|------|
| アクター | システム（自動） |
| 概要 | 子供の年齢に対して価値が低い活動を自動的に非表示にする |
| 事前条件 | 活動に対象年齢範囲が設定されている |
| 事後条件 | 対象外の活動が子供の画面から非表示になる |

**主フロー:**
1. 子供の年齢が更新された時（誕生日バッチ or 手動更新）に実行
2. 全活動の対象年齢範囲をチェック
3. 子供の年齢が範囲外の活動を自動非表示に設定
4. 親への通知（管理画面のお知らせ）

**代替フロー:**
- 3a. 親が手動で表示に戻した活動は自動非表示の対象外

---

## 4. 画面遷移概要

### 子供用画面

```
┌─────────────┐
│ 子供切替     │
│ (UC-05)     │
└──────┬──────┘
       │
┌──────▼──────┐
│  ホーム      │ ← ナビゲーション「ホーム」
│  活動記録    │
│  (UC-01)    │
│  (UC-02)    │
└──┬───┬──┬───┘
   │   │  │
┌──▼┐ ┌▼──┐ ┌▼──┐
│きろく│ │つよさ│ │設定│
│履歴 │ │ステ │ │   │
│UC-03│ │UC-04│ │   │
└────┘ └────┘ └────┘
```

### 親用管理画面

```
┌─────────────┐
│ PIN認証      │
│ (UC-09)     │
└──────┬──────┘
       │
┌──────▼──────┐
│ ダッシュボード│
└──┬──┬──┬──┬─┘
   │  │  │  │
┌──▼┐┌▼──┐┌▼──┐┌▼──────┐
│活動││ポイ││表示││子供の  │
│管理││ント││非表││ステータス│
│UC-06││変換││示  ││確認    │
│    ││UC-07││UC-08││       │
└────┘└────┘└────┘└───────┘
```

---

### UC-13: ログインボーナスを受け取る

| 項目 | 内容 |
|------|------|
| アクター | 子供 |
| 概要 | 1日1回、アプリアクセス時におみくじ形式でボーナスポイントを獲得する |
| 事前条件 | 子供用ホーム画面にアクセス。当日のログインボーナスが未受取 |
| 事後条件 | ログインボーナスが記録され、ポイントが付与される |

**主フロー:**
1. 子供がホーム画面にアクセスする
2. 当日のログインボーナスが未受取の場合、おみくじ演出が開始される
3. おみくじが回転するアニメーション
4. 結果が表示される（運勢ランク＋獲得ポイント）
   - 大大吉の場合：金色エフェクト＋特別アニメーション
   - 大吉の場合：虹色エフェクト
5. 連続ログイン日数が表示される（「○にちれんぞく！」）
6. 画面をタップするとホーム画面に遷移

**代替フロー:**
- 2a. 当日既に受取済み → おみくじ演出なし、直接ホーム画面を表示

---

## 5. 補足：今後追加予定のユースケース

| UC | 概要 | 備考 |
|----|------|------|
| UC-14 | ごほうび交換（ポイントで特別なごほうびを獲得） | ゲーミフィケーション強化 |
| UC-15 | 実績・バッジ獲得（特定条件で特別バッジ） | 長期的な動機付け |
| UC-16 | 親子チャレンジ（親子で一緒に達成する目標） | 家族の絆強化 |
| UC-17 | データエクスポート（成長記録のPDF出力等） | 記念・振り返り用 |

※ first-input.md の「思いつき次第更新します」に対応。追加時は本文書を更新。
