# がんばりクエスト テスト設計書

| 項目 | 内容 |
|------|------|
| 版数 | 1.0 |
| 作成日 | 2026-02-20 |
| 作成者 | 日下武紀 |

---

## 1. 文書の目的

テスト戦略、テストケース設計、カバレッジ目標を定め、品質を確保しつつ効率的にテストを実行するための指針を示す。本文書はユースケース設計書（03）、API設計書（07）、DB設計書（08）を入力とする。

---

## 2. テスト方針

### 基本原則

- **テスト駆動開発（TDD）**: サービス層は Red → Green → Refactor サイクルで実装
- **ユースケースベース**: E2Eテストは全ユースケース（UC-01〜UC-12）をカバー
- **4歳児視点**: UIテストは「読めない」「タップのみ」を前提にユーザビリティ観点を含める
- **自動化優先**: 手動テストは最小限に留め、CI/CDで自動実行

### テスト環境

| 環境 | 用途 | データベース |
|------|------|------------|
| ユニット/統合テスト | Vitest | インメモリSQLite |
| E2Eテスト | Playwright | テスト専用SQLiteファイル |
| 開発時手動確認 | ブラウザ | 開発用SQLiteファイル |

---

## 3. テストレベル定義

### 3.1 ユニットテスト

| 項目 | 内容 |
|------|------|
| ツール | Vitest |
| 対象 | サービス層、ドメインロジック、ユーティリティ |
| カバレッジ目標 | 80%以上（行カバレッジ） |
| 実行タイミング | コミット前、CI |

**対象モジュール:**

| モジュール | テストファイル | 優先度 |
|-----------|--------------|--------|
| activity-service | `tests/unit/services/activity-service.test.ts` | 高 |
| point-service | `tests/unit/services/point-service.test.ts` | 高 |
| status-service | `tests/unit/services/status-service.test.ts` | 高 |
| evaluation-service | `tests/unit/services/evaluation-service.test.ts` | 中 |
| auth-service | `tests/unit/services/auth-service.test.ts` | 高 |
| decay-service | `tests/unit/services/decay-service.test.ts` | 中 |
| ドメインモデル | `tests/unit/domain/*.test.ts` | 中 |
| ユーティリティ | `tests/unit/utils/*.test.ts` | 低 |

### 3.2 コンポーネントテスト

| 項目 | 内容 |
|------|------|
| ツール | Vitest + Svelte Testing Library |
| 対象 | 主要UIコンポーネント |
| カバレッジ目標 | 主要コンポーネントの表示・操作を網羅 |
| 実行タイミング | コミット前、CI |

**対象コンポーネント:**

| コンポーネント | テスト観点 | 優先度 |
|---------------|----------|--------|
| ActivityIcon | アイコン表示、タップイベント発火 | 高 |
| ActivityGrid | 一覧表示、カテゴリフィルタ | 高 |
| ConfirmDialog | 活動名表示、「やった！」「もどる」ボタン | 高 |
| CompletionAnimation | アニメーション表示、キャンセルボタン表示/非表示 | 中 |
| StatusGauge | ゲージ値表示、星マーク | 中 |
| PinInput | 数字入力、桁数検証 | 高 |
| PointDisplay | 残高表示、変換可能額 | 中 |
| ChildSwitcher | 子供一覧表示、切り替え動作 | 中 |
| Navigation | アイコンナビゲーション、現在ページハイライト | 中 |

### 3.3 APIテスト（統合テスト）

| 項目 | 内容 |
|------|------|
| ツール | Vitest + supertest (or SvelteKit テストユーティリティ) |
| 対象 | 全APIエンドポイント |
| カバレッジ目標 | 全エンドポイントの正常系＋主要異常系 |
| 実行タイミング | CI |

### 3.4 E2Eテスト

| 項目 | 内容 |
|------|------|
| ツール | Playwright |
| 対象 | 全ユースケース（UC-01〜UC-12のうちUI操作を伴うもの） |
| ブラウザ | Chromium（タブレットビューポート 1280x800） |
| 実行タイミング | CI、リリース前 |

---

## 4. テストケース一覧

### 4.1 ユニットテスト詳細

#### activity-service

| TC-ID | テストケース | 入力 | 期待結果 |
|-------|------------|------|---------|
| UT-ACT-01 | 活動一覧取得（全件） | なし | 全活動が返される |
| UT-ACT-02 | 活動一覧取得（子供IDフィルタ） | childId=1 (4歳) | 年齢範囲内かつ表示中の活動のみ返される |
| UT-ACT-03 | 活動一覧取得（カテゴリフィルタ） | category="うんどう" | 該当カテゴリのみ返される |
| UT-ACT-04 | 活動一覧取得（非表示含む） | includeHidden=true | 非表示活動も含めて返される |
| UT-ACT-05 | 活動追加（正常） | 有効な活動データ | 活動が追加される |
| UT-ACT-06 | 活動追加（名前重複） | 既存活動名 | 重複エラー or 警告 |
| UT-ACT-07 | 活動更新（正常） | 有効な更新データ | 活動が更新される |
| UT-ACT-08 | 活動表示/非表示切替 | activityId, isVisible | 表示状態が変更される |
| UT-ACT-09 | 年齢範囲フィルタ | ageMin=5の活動, 4歳の子供 | 該当活動が除外される |
| UT-ACT-10 | 日次上限チェック | dailyLimit=3, 当日3回記録済み | 記録不可を返す |

#### activity-log-service

| TC-ID | テストケース | 入力 | 期待結果 |
|-------|------------|------|---------|
| UT-LOG-01 | 活動記録（正常） | childId=1, activityId=3 | ログ作成、ポイント仮付与 |
| UT-LOG-02 | 活動記録（同日重複） | 同日に同活動を再記録 | ALREADY_RECORDED エラー (409) |
| UT-LOG-03 | 活動記録（翌日の同活動） | 昨日記録済み、今日再記録 | 正常に記録される |
| UT-LOG-04 | 活動記録キャンセル（5秒以内） | logId, 記録後3秒 | ログ削除、ポイント返還 |
| UT-LOG-05 | 活動記録キャンセル（5秒超過） | logId, 記録後6秒 | CANCEL_EXPIRED エラー |
| UT-LOG-06 | ストリーク（2日連続） | 昨日同活動記録済み | streakDays=2, streakBonus=1 |
| UT-LOG-07 | ストリーク（5日連続） | 4日連続記録済み | streakDays=5, streakBonus=4 |
| UT-LOG-08 | ストリーク（途切れ） | 2日前に記録、昨日なし | streakDays=1, streakBonus=0 |
| UT-LOG-09 | ストリーク上限（11日以上） | 10日連続記録済み | streakDays=11, streakBonus=10（上限） |
| UT-LOG-10 | 活動ログ取得（週間） | childId=1, period="week" | 今週のログとサマリー |
| UT-LOG-11 | 活動ログ取得（月間） | childId=1, period="month" | 今月のログとサマリー |
| UT-LOG-12 | 活動ログ取得（カテゴリ別集計） | childId=1 | byCategory に正しい集計値 |
| UT-LOG-13 | 活動ログ取得（空） | childId=1, 記録なし | 空のログリスト、集計値すべて0 |

#### point-service

| TC-ID | テストケース | 入力 | 期待結果 |
|-------|------------|------|---------|
| UT-PNT-01 | ポイント残高取得 | childId=1 | balance, convertableAmount が正しい |
| UT-PNT-02 | ポイント変換（正常、500P） | childId=1, amount=500 | 残高から500減算、変換履歴記録 |
| UT-PNT-03 | ポイント変換（正常、1000P） | childId=1, amount=1000 | 残高から1000減算 |
| UT-PNT-04 | ポイント変換（残高不足） | childId=1, amount=500, 残高300 | INSUFFICIENT_POINTS エラー |
| UT-PNT-05 | ポイント変換（500P単位以外） | amount=300 | バリデーションエラー |
| UT-PNT-06 | ポイント加算（活動記録時） | childId=1, points=5 | 残高に5加算 |
| UT-PNT-07 | ポイント減算（キャンセル時） | childId=1, points=5 | 残高から5減算 |
| UT-PNT-08 | ポイント履歴取得 | childId=1 | 変換・加算・減算履歴が時系列で返される |

#### status-service

| TC-ID | テストケース | 入力 | 期待結果 |
|-------|------------|------|---------|
| UT-STS-01 | ステータス取得 | childId=1 | 5カテゴリのステータス値 |
| UT-STS-02 | レベル算出 | totalPoints=1250 | レベル4, "つよつよチャレンジャー" |
| UT-STS-03 | レベル算出（境界値: 0P） | totalPoints=0 | レベル1, "はじまりのぼうけんしゃ" |
| UT-STS-04 | レベル算出（境界値: 99P） | totalPoints=99 | レベル1 |
| UT-STS-05 | レベル算出（境界値: 100P） | totalPoints=100 | レベル2 |
| UT-STS-06 | 偏差値算出 | 活動量, 市場ベンチマーク | 正しい偏差値が算出される |
| UT-STS-07 | 星マーク算出（偏差値55以上） | deviationScore=58 | 星3つ |
| UT-STS-08 | 星マーク算出（偏差値45未満） | deviationScore=42 | 星1つ |
| UT-STS-09 | トレンド算出（上昇） | 先週より増加 | trend="up" |
| UT-STS-10 | トレンド算出（下降） | 先週より減少 | trend="down" |
| UT-STS-11 | トレンド算出（安定） | 先週と同等 | trend="stable" |

#### decay-service

| TC-ID | テストケース | 入力 | 期待結果 |
|-------|------------|------|---------|
| UT-DEC-01 | 1日未活動（4歳、うんどう） | 経過日数=1 | 基礎減少量 = 0.8 × 基礎値 |
| UT-DEC-02 | 3日連続未活動 | 経過日数=3 | 基礎減少量 + 連続未活動ボーナス(α×2) |
| UT-DEC-03 | ステータス値下限チェック | 現在値=1, 減少量=5 | ステータス値=0（負にならない） |
| UT-DEC-04 | 当日活動済みカテゴリ | lastActivityAt=今日 | 減少なし |
| UT-DEC-05 | 年齢係数の確認（4歳） | age=4 | 係数=0.8 |
| UT-DEC-06 | 年齢係数の確認（7歳） | age=7 | 係数=1.0 |

#### auth-service

| TC-ID | テストケース | 入力 | 期待結果 |
|-------|------------|------|---------|
| UT-AUTH-01 | PIN認証（正常） | pin="1234" (正しいPIN) | authenticated=true, セッショントークン発行 |
| UT-AUTH-02 | PIN認証（不正） | pin="9999" (不正PIN) | authenticated=false, remainingAttempts返却 |
| UT-AUTH-03 | PIN認証（5回連続失敗） | 5回連続不正PIN | LOCKED_OUT, unlocksAt返却 |
| UT-AUTH-04 | ロックアウト中の認証試行 | ロック中にPIN入力 | LOCKED_OUT エラー |
| UT-AUTH-05 | ロックアウト解除後 | 5分経過後に正しいPIN | 認証成功 |
| UT-AUTH-06 | PIN初期設定 | pin="5678" (初回) | PIN設定完了 |
| UT-AUTH-07 | セッション有効期限確認 | 30分超過したトークン | 無効と判定 |
| UT-AUTH-08 | セッション延長 | 操作発生 | 有効期限が30分延長 |
| UT-AUTH-09 | PINハッシュ検証 | 平文PINとハッシュ | bcryptで正しく照合される |

#### evaluation-service

| TC-ID | テストケース | 入力 | 期待結果 |
|-------|------------|------|---------|
| UT-EVL-01 | 週次評価（正常） | 1週間の活動ログ | 評価結果＋ポイント付与 |
| UT-EVL-02 | 週次評価（活動なし） | 空のログ | 評価スコア0、ポイント0 |
| UT-EVL-03 | カテゴリ別スコア算出 | カテゴリ別活動量 | 正しいスコアが算出される |
| UT-EVL-04 | 市場比較による偏差値 | 活動量＋ベンチマーク | 正しい偏差値が返される |

#### login-bonus-service

| TC-ID | テストケース | 入力 | 期待結果 |
|-------|------------|------|---------|
| UT-LB-01 | ログインボーナス受取（正常） | childId=1, 当日未受取 | おみくじランクとポイントが返される |
| UT-LB-02 | ログインボーナス受取（重複） | childId=1, 当日受取済み | ALREADY_CLAIMED エラー |
| UT-LB-03 | おみくじ確率分布 | 1000回試行 | 各ランクの出現率が設計値±5%以内 |
| UT-LB-04 | 連続ログイン3日（1.5倍） | 3日連続ログイン | multiplier=1.5, ポイントが1.5倍（切り上げ） |
| UT-LB-05 | 連続ログイン7日（2.0倍） | 7日連続ログイン | multiplier=2.0 |
| UT-LB-06 | 連続ログイン途切れ | 昨日未ログイン | consecutiveDays=1, multiplier=1.0 |
| UT-LB-07 | 連続ログイン30日（3.0倍） | 30日連続 | multiplier=3.0 |
| UT-LB-08 | 大大吉のポイント計算 | rank="大大吉", 7日連続 | basePoints=20, totalPoints=40 |

### 4.2 APIテスト詳細

#### 子供関連 API

| TC-ID | エンドポイント | テストケース | 期待ステータス |
|-------|-------------|------------|--------------|
| API-CHD-01 | GET /api/v1/children | 子供一覧取得 | 200 |
| API-CHD-02 | GET /api/v1/children/1 | 子供詳細取得（存在する） | 200 |
| API-CHD-03 | GET /api/v1/children/999 | 子供詳細取得（存在しない） | 404 |

#### 活動関連 API

| TC-ID | エンドポイント | テストケース | 期待ステータス |
|-------|-------------|------------|--------------|
| API-ACT-01 | GET /api/v1/activities | 活動一覧取得 | 200 |
| API-ACT-02 | GET /api/v1/activities?childId=1 | 子供IDフィルタ | 200 |
| API-ACT-03 | GET /api/v1/activities?category=うんどう | カテゴリフィルタ | 200 |
| API-ACT-04 | POST /api/v1/activities | 活動追加（認証あり） | 201 |
| API-ACT-05 | POST /api/v1/activities | 活動追加（認証なし） | 401 |
| API-ACT-06 | POST /api/v1/activities | バリデーションエラー | 400 |
| API-ACT-07 | PATCH /api/v1/activities/1 | 活動更新（認証あり） | 200 |
| API-ACT-08 | PATCH /api/v1/activities/1/visibility | 表示/非表示切替 | 200 |

#### 活動ログ関連 API

| TC-ID | エンドポイント | テストケース | 期待ステータス |
|-------|-------------|------------|--------------|
| API-LOG-01 | POST /api/v1/activity-logs | 活動記録（正常、ストリーク情報含む） | 201 |
| API-LOG-02 | POST /api/v1/activity-logs | 同日重複記録 | 409 |
| API-LOG-03 | POST /api/v1/activity-logs | バリデーションエラー | 400 |
| API-LOG-04 | DELETE /api/v1/activity-logs/1 | キャンセル（5秒以内） | 200 |
| API-LOG-05 | DELETE /api/v1/activity-logs/1 | キャンセル（期限超過） | 400 |
| API-LOG-06 | GET /api/v1/activity-logs?childId=1 | ログ取得 | 200 |
| API-LOG-07 | GET /api/v1/activity-logs | childId未指定 | 400 |

#### ポイント関連 API

| TC-ID | エンドポイント | テストケース | 期待ステータス |
|-------|-------------|------------|--------------|
| API-PNT-01 | GET /api/v1/points/1 | ポイント残高取得 | 200 |
| API-PNT-02 | GET /api/v1/points/1/history | ポイント履歴取得 | 200 |
| API-PNT-03 | POST /api/v1/points/convert | ポイント変換（認証あり） | 200 |
| API-PNT-04 | POST /api/v1/points/convert | ポイント変換（認証なし） | 401 |
| API-PNT-05 | POST /api/v1/points/convert | 残高不足 | 400 |
| API-PNT-06 | POST /api/v1/points/convert | 500P単位以外 | 400 |

#### ステータス関連 API

| TC-ID | エンドポイント | テストケース | 期待ステータス |
|-------|-------------|------------|--------------|
| API-STS-01 | GET /api/v1/status/1 | ステータス取得 | 200 |
| API-STS-02 | GET /api/v1/status/999 | 存在しない子供 | 404 |

#### 認証関連 API

| TC-ID | エンドポイント | テストケース | 期待ステータス |
|-------|-------------|------------|--------------|
| API-AUTH-01 | POST /api/v1/auth/pin/verify | PIN認証成功 | 200 |
| API-AUTH-02 | POST /api/v1/auth/pin/verify | PIN不一致 | 401 |
| API-AUTH-03 | POST /api/v1/auth/pin/verify | ロックアウト中 | 429 |
| API-AUTH-04 | POST /api/v1/auth/pin/setup | PIN初期設定 | 200 |
| API-AUTH-05 | POST /api/v1/auth/pin/setup | PIN設定済みで再設定 | 400 |

#### ログインボーナス関連 API

| TC-ID | エンドポイント | テストケース | 期待ステータス |
|-------|-------------|------------|--------------|
| API-LB-01 | GET /api/v1/login-bonus/1 | ボーナス状態取得 | 200 |
| API-LB-02 | POST /api/v1/login-bonus/1/claim | ボーナス受取（正常） | 201 |
| API-LB-03 | POST /api/v1/login-bonus/1/claim | ボーナス受取済み | 409 |
| API-LB-04 | GET /api/v1/login-bonus/999 | 存在しない子供 | 404 |

#### ヘルスチェック API

| TC-ID | エンドポイント | テストケース | 期待ステータス |
|-------|-------------|------------|--------------|
| API-HLT-01 | GET /api/health | ヘルスチェック | 200 |

### 4.3 E2Eテストシナリオ

#### E2E-01: 子供が活動を記録する（UC-01, UC-02）

```
テストファイル: tests/e2e/child-record-activity.spec.ts
前提条件: テスト用子供（4歳）と活動データがシード済み
ビューポート: 1280x800（タブレット想定）

シナリオ1: 正常な活動記録
  1. ホーム画面を表示
  2. 活動アイコン一覧が表示されることを確認（アイコンが64px以上）
  3. 「たいそうした」アイコンをタップ
  4. 確認画面に活動名アイコンと「やった！」ボタンが表示されることを確認
  5. 「やった！」ボタンをタップ
  6. 完了アニメーションと獲得ポイント（+5）が表示されることを確認
  7. 「キャンセル」ボタンが表示されることを確認
  8. 5秒後にホーム画面に自動遷移することを確認

シナリオ2: 活動記録のキャンセル
  1. ホーム画面で活動アイコンをタップ
  2. 確認画面で「やった！」をタップ
  3. 完了画面で「キャンセル」ボタンをタップ（5秒以内）
  4. 「けしました」が表示されることを確認
  5. ポイントが元に戻っていることを確認

シナリオ3: 確認画面で戻る
  1. ホーム画面で活動アイコンをタップ
  2. 確認画面で「もどる」ボタンをタップ
  3. ホーム画面に戻ることを確認（記録なし）

シナリオ4: 同日重複記録の防止
  1. ホーム画面で「たいそうした」を記録（シナリオ1を実施）
  2. ホーム画面に戻り「たいそうした」がグレーアウト＋チェックマークで表示されることを確認
  3. グレーアウトされたアイコンがタップ不可であることを確認

シナリオ5: ストリークボーナスの表示
  1. 前日に「たいそうした」を記録済みの状態でテスト開始
  2. 本日「たいそうした」を記録
  3. 完了画面に「🔥2日れんぞく！+1ボーナス」が表示されることを確認
  4. 合計ポイントが基本ポイント+ストリークボーナスであることを確認
```

#### E2E-02: 子供がステータスを確認する（UC-04）

```
テストファイル: tests/e2e/child-view-status.spec.ts
前提条件: テスト用子供にステータス値が設定済み

シナリオ1: ステータス画面の表示
  1. ナビゲーションの「つよさ」アイコンをタップ
  2. レベル表示（大きな数字＋レベルバー）が表示されることを確認
  3. 5カテゴリのステータスゲージが表示されることを確認
  4. キャラクター画像が表示されることを確認
  5. 星マーク（市場比較）が各カテゴリに表示されることを確認

シナリオ2: キャラクター拡大表示
  1. ステータス画面を表示
  2. キャラクターをタップ
  3. キャラクターが拡大表示されることを確認
```

#### E2E-03: 子供が活動履歴を確認する（UC-03）

```
テストファイル: tests/e2e/child-view-history.spec.ts
前提条件: テスト用活動ログが存在する

シナリオ1: 履歴画面の表示
  1. ナビゲーションの「きろく」アイコンをタップ
  2. 今週の活動一覧（アイコン＋日付＋ポイント）が表示されることを確認
  3. カテゴリ別の集計が表示されることを確認

シナリオ2: 期間切替
  1. 履歴画面を表示
  2. 「今月」タブをタップ
  3. 今月の活動一覧に切り替わることを確認
  4. 「今年」タブをタップ
  5. 今年の活動一覧に切り替わることを確認

シナリオ3: 履歴なし
  1. 活動記録のない子供で履歴画面を表示
  2. 「まだきろくがないよ！」メッセージが表示されることを確認
```

#### E2E-04: 子供を切り替える（UC-05）

```
テストファイル: tests/e2e/child-switch.spec.ts
前提条件: 複数の子供が登録済み

シナリオ1: 子供の切替
  1. 画面上部の子供アイコンをタップ
  2. 子供一覧（アイコン＋名前）が表示されることを確認
  3. 別の子供をタップ
  4. 画面テーマ（色味）が切り替わることを確認
  5. 切り替えた子供のデータが表示されることを確認
```

#### E2E-05: 親がPIN認証する（UC-09）

```
テストファイル: tests/e2e/parent-pin-auth.spec.ts
前提条件: PINコードが設定済み

シナリオ1: PIN認証成功
  1. 管理画面URLにアクセス
  2. PIN入力画面が表示されることを確認
  3. 正しいPIN（4桁）を入力
  4. 管理画面ダッシュボードに遷移することを確認

シナリオ2: PIN認証失敗
  1. 管理画面URLにアクセス
  2. 誤ったPINを入力
  3. 「PINがちがいます」が表示されることを確認
  4. 残り試行回数が表示されることを確認

シナリオ3: ロックアウト
  1. 5回連続で誤ったPINを入力
  2. 「5分間ロックされています」が表示されることを確認
  3. PIN入力が無効化されることを確認

シナリオ4: PIN初期設定
  1. PINが未設定の状態で管理画面にアクセス
  2. PIN設定画面が表示されることを確認
  3. PINを2回入力（確認入力含む）
  4. 設定完了後、管理画面ダッシュボードに遷移することを確認
```

#### E2E-06: 親が活動を追加する（UC-06）

```
テストファイル: tests/e2e/parent-manage-activities.spec.ts
前提条件: PIN認証済みで管理画面にログイン

シナリオ1: 活動追加
  1. 管理画面の「活動管理」を選択
  2. 「新規追加」ボタンをタップ
  3. 活動名: 「さんすうをした」
  4. カテゴリ: 「べんきょう」を選択
  5. アイコン: 選択
  6. 基本ポイント: 5
  7. 「保存」ボタンをタップ
  8. 活動一覧に追加されていることを確認
```

#### E2E-07: 親がポイントを変換する（UC-07）

```
テストファイル: tests/e2e/parent-convert-points.spec.ts
前提条件: PIN認証済み、子供のポイント残高が1000以上

シナリオ1: ポイント変換
  1. 管理画面の「ポイント管理」を選択
  2. 子供のポイント残高が表示されることを確認
  3. 「変換」ボタンをタップ
  4. 変換額「500」を選択
  5. 確認ダイアログが表示されることを確認
  6. 「はい」をタップ
  7. ポイント残高が500減っていることを確認
  8. 変換履歴に記録されていることを確認

シナリオ2: 残高不足
  1. ポイント残高が500未満の子供を表示
  2. 「変換」ボタンが非活性であることを確認
  3. 「あと○○ポイント！」が表示されることを確認
```

#### E2E-08: 親が活動の表示/非表示を切り替える（UC-08）

```
テストファイル: tests/e2e/parent-toggle-visibility.spec.ts
前提条件: PIN認証済み

シナリオ1: 活動を非表示にする
  1. 管理画面の「活動管理」を選択
  2. 活動一覧でトグルスイッチを確認
  3. 表示中の活動のトグルをオフにする
  4. 子供用ホーム画面で非表示になっていることを確認
```

#### E2E-09: 子供がログインボーナスを受け取る（UC-13）

```
テストファイル: tests/e2e/child-login-bonus.spec.ts
前提条件: テスト用子供（4歳）でログインボーナス未受取

シナリオ1: ログインボーナス受取
  1. ホーム画面にアクセス
  2. おみくじ演出が表示されることを確認
  3. おみくじが回転するアニメーションが表示されることを確認
  4. 結果（ランク＋ポイント）が表示されることを確認
  5. 画面をタップ
  6. ホーム画面に遷移し、ポイントが加算されていることを確認

シナリオ2: ログインボーナス受取済み
  1. ログインボーナスを受取済みの状態でホーム画面にアクセス
  2. おみくじ演出が表示されないことを確認
  3. 直接ホーム画面が表示されることを確認

シナリオ3: 連続ログインボーナス
  1. 3日連続ログイン済みの状態（テストデータ）
  2. ホーム画面にアクセス
  3. おみくじ結果に「×1.5ばい」の倍率が表示されることを確認
  4. ポイントが倍率適用後の値であることを確認
```

---

## 5. テストデータ設計

### 5.1 テストフィクスチャ

```
tests/
├── fixtures/
│   ├── seed.ts              # テストDBシードデータ
│   ├── children.ts          # 子供テストデータ
│   ├── activities.ts        # 活動テストデータ
│   ├── activity-logs.ts     # 活動ログテストデータ
│   ├── login-bonuses.ts     # ログインボーナステストデータ
│   └── market-benchmarks.ts # 市場ベンチマークデータ
├── helpers/
│   ├── db.ts                # テスト用DBセットアップ/クリーンアップ
│   ├── auth.ts              # テスト用認証ヘルパー
│   └── api.ts               # APIテスト用ヘルパー
```

### 5.2 シードデータ

#### 子供データ

| ID | ニックネーム | 年齢 | テーマ |
|----|------------|------|--------|
| 1 | おじょうさま | 4 | pink |
| 2 | ぼっちゃま | 0 | blue |
| 3 | テスト太郎 | 7 | green |

※ ID=3はテスト専用。年齢違いの動作確認用。

#### 活動データ

08-データベース設計書のシードデータ（15件）をそのまま使用。

#### 活動ログデータ

| 子供ID | 活動 | 日時 | ポイント |
|--------|------|------|---------|
| 1 | たいそうした | 当日09:00 | 5 |
| 1 | しょっきをはこんだ | 当日18:00 | 5 |
| 1 | おえかきした | 前日15:00 | 5 |
| 1 | あいさつした | 2日前08:00 | 3 |
| 1 | たいそうした | 3日前09:00 | 5 |
| 1 | はみがきした | 3日前20:00 | 3 |
| 1 | おかたづけした | 4日前17:00 | 5 |
| 1 | えほんをよんだ | 5日前19:00 | 5 |

#### 市場ベンチマーク

08-データベース設計書のシードデータ（4歳のベンチマーク）を使用。

### 5.3 テストDB管理

```typescript
// tests/helpers/db.ts
import { drizzle } from 'drizzle-orm/better-sqlite3';
import Database from 'better-sqlite3';
import * as schema from '$lib/server/db/schema';
import { seedTestData } from '../fixtures/seed';

export function createTestDb() {
  const sqlite = new Database(':memory:');
  const db = drizzle(sqlite, { schema });
  // マイグレーション実行
  // シードデータ投入
  seedTestData(db);
  return { db, sqlite };
}

export function cleanupTestDb(sqlite: Database.Database) {
  sqlite.close();
}
```

---

## 6. テスト環境構成

### 6.1 ディレクトリ構成

```
tests/
├── unit/
│   ├── services/
│   │   ├── activity-service.test.ts
│   │   ├── activity-log-service.test.ts
│   │   ├── point-service.test.ts
│   │   ├── status-service.test.ts
│   │   ├── evaluation-service.test.ts
│   │   ├── auth-service.test.ts
│   │   ├── decay-service.test.ts
│   │   └── login-bonus-service.test.ts
│   └── domain/
│       ├── level.test.ts
│       ├── streak.test.ts
│       └── deviation-score.test.ts
├── integration/
│   └── api/
│       ├── children.test.ts
│       ├── activities.test.ts
│       ├── activity-logs.test.ts
│       ├── points.test.ts
│       ├── status.test.ts
│       ├── auth.test.ts
│       ├── login-bonus.test.ts
│       └── health.test.ts
├── e2e/
│   ├── child-record-activity.spec.ts
│   ├── child-view-status.spec.ts
│   ├── child-view-history.spec.ts
│   ├── child-switch.spec.ts
│   ├── parent-pin-auth.spec.ts
│   ├── parent-manage-activities.spec.ts
│   ├── parent-convert-points.spec.ts
│   ├── parent-toggle-visibility.spec.ts
│   └── child-login-bonus.spec.ts
├── fixtures/
│   ├── seed.ts
│   ├── children.ts
│   ├── activities.ts
│   ├── activity-logs.ts
│   └── market-benchmarks.ts
└── helpers/
    ├── db.ts
    ├── auth.ts
    └── api.ts
```

### 6.2 設定ファイル

#### vitest.config.ts

```typescript
import { defineConfig } from 'vitest/config';
import { sveltekit } from '@sveltejs/kit/vite';

export default defineConfig({
  plugins: [sveltekit()],
  test: {
    include: ['tests/unit/**/*.test.ts', 'tests/integration/**/*.test.ts'],
    environment: 'jsdom',
    globals: true,
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'lcov'],
      include: ['src/lib/**/*.ts', 'src/lib/**/*.svelte'],
      exclude: ['src/lib/**/*.d.ts', 'src/lib/**/index.ts'],
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 75,
        statements: 80,
      },
    },
    setupFiles: ['tests/helpers/setup.ts'],
  },
});
```

#### playwright.config.ts

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: 'tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [['html'], ['json', { outputFile: 'test-results.json' }]],
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'tablet',
      use: {
        ...devices['iPad (gen 7)'],
        viewport: { width: 1280, height: 800 },
      },
    },
    {
      name: 'mobile',
      use: {
        ...devices['iPhone 14'],
      },
    },
  ],
  webServer: {
    command: 'npm run dev',
    port: 5173,
    reuseExistingServer: !process.env.CI,
  },
});
```

### 6.3 テスト実行コマンド

```bash
# ユニット + 統合テスト
npm run test

# ユニット + 統合テスト（ウォッチモード）
npm run test:watch

# カバレッジレポート付き
npm run test:coverage

# E2Eテスト
npm run test:e2e

# E2Eテスト（UIモード）
npm run test:e2e:ui

# 全テスト
npm run test:all
```

#### package.json scripts

```json
{
  "scripts": {
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:all": "vitest run && playwright test"
  }
}
```

---

## 7. テスト品質基準

### 7.1 カバレッジ目標

| レイヤ | 行カバレッジ | 関数カバレッジ | 分岐カバレッジ |
|--------|-----------|-------------|-------------|
| サービス層 | 80% | 80% | 75% |
| ドメインロジック | 90% | 90% | 85% |
| UIコンポーネント | 60% | - | - |
| 全体 | 80% | 80% | 75% |

### 7.2 E2Eテスト合格基準

| 項目 | 基準 |
|------|------|
| 全シナリオ通過 | 必須 |
| テスト実行時間 | 5分以内 |
| フレイキーテスト | 0件 |

### 7.3 テストのDONE基準

テストが「完了」と見なされる条件：

1. ユニットテストのカバレッジが目標を満たしている
2. 全APIエンドポイントの正常系テストが通過
3. 全E2Eシナリオが通過
4. テスト用DBのセットアップ/クリーンアップが正しく動作する
5. CIで自動実行され、結果がレポートとして出力される

---

## 8. 4歳児ユーザビリティテスト観点

通常の機能テストに加え、以下のユーザビリティ観点を確認する。

### 8.1 タッチ操作

| 確認項目 | 合格基準 |
|---------|---------|
| タップターゲットサイズ | 全タップ可能要素が64x64px以上 |
| タップ間隔 | 隣接するタップターゲット間に8px以上の余白 |
| 誤タップ防止 | 確認画面で重要操作前にワンクッション |
| 長押し不要 | 長押しを必要とする操作がないこと |

### 8.2 視覚的フィードバック

| 確認項目 | 合格基準 |
|---------|---------|
| タップ時フィードバック | タップ時に視覚的変化（色・サイズ）がある |
| 操作完了通知 | 記録完了時にアニメーションが表示される |
| エラー表示 | アイコンベースのエラー表示（文字だけでない） |
| ローディング | 処理中にスピナーまたはスケルトンが表示される |

### 8.3 ナビゲーション

| 確認項目 | 合格基準 |
|---------|---------|
| ナビゲーションアイコン | アイコンで識別可能（文字なしでも理解できる） |
| 現在地表示 | 今いるページがナビゲーションで強調される |
| 戻る操作 | どの画面からも1タップでホームに戻れる |

---

## 9. CI/CD統合

### 9.1 テスト自動化フロー

```
git push → GitHub Actions
    │
    ├── Lint (Biome)
    ├── 型チェック (tsc --noEmit)
    ├── ユニット + 統合テスト (Vitest)
    │   └── カバレッジレポート出力
    └── E2Eテスト (Playwright)
        └── スクリーンショット保存（失敗時）
```

### 9.2 テスト失敗時のルール

- ユニット/統合テスト失敗 → マージブロック
- E2Eテスト失敗 → マージブロック
- カバレッジ低下 → 警告（ブロックはしない）
- フレイキーテスト検出 → 即座にスキップではなく原因調査

---

## 10. テスト実装の優先順位

### フェーズ1: コアロジック（実装チケット#0013-0015と同時）

1. activity-service ユニットテスト
2. point-service ユニットテスト
3. auth-service ユニットテスト
4. 活動関連 API テスト
5. 認証関連 API テスト

### フェーズ2: ステータス・評価（実装チケット#0015と同時）

1. status-service ユニットテスト
2. decay-service ユニットテスト
3. evaluation-service ユニットテスト
4. ステータス関連 API テスト

### フェーズ3: UI・E2E（実装チケット#0017-0018と同時）

1. 主要コンポーネントテスト
2. E2Eテスト（子供用フロー）
3. E2Eテスト（親用フロー）

### フェーズ4: 統合・仕上げ（実装チケット#0019と同時）

1. カバレッジ目標達成の確認
2. フレイキーテストの解消
3. CI/CD設定の完了
