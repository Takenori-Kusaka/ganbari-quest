# がんばりクエスト データベース設計書

| 項目 | 内容 |
|------|------|
| 版数 | 1.0 |
| 作成日 | 2026-02-19 |
| 作成者 | 日下武紀 |

---

## 1. 設計方針

- **SQLite**: 単一ファイルDB。NUCサーバーでの運用に最適
- **Drizzle ORM**: TypeScript型安全なスキーマ定義
- **WAL モード**: 読み書き並行性を向上
- **バックアップ**: 日次で git push（DBファイルのコピー）

---

## 2. ER図

```
┌──────────────┐     ┌──────────────────┐
│   children   │     │    activities     │
│──────────────│     │──────────────────│
│ id (PK)      │     │ id (PK)          │
│ nickname     │     │ name             │
│ age          │     │ category         │
│ theme        │     │ icon             │
│ created_at   │     │ base_points      │
│ updated_at   │     │ age_min          │
└──────┬───────┘     │ age_max          │
       │             │ is_visible       │
       │             │ daily_limit      │
       │             │ created_at       │
       │             └────────┬─────────┘
       │                      │
       │    ┌─────────────────┘
       │    │
┌──────▼────▼──────┐
│  activity_logs   │
│──────────────────│
│ id (PK)          │
│ child_id (FK)    │──→ children.id
│ activity_id (FK) │──→ activities.id
│ points           │
│ recorded_at      │
│ cancelled        │
└──────────────────┘

┌──────────────────┐
│   point_ledger   │
│──────────────────│
│ id (PK)          │
│ child_id (FK)    │──→ children.id
│ amount           │
│ type             │  (earn / spend / convert)
│ description      │
│ created_at       │
└──────────────────┘

┌──────────────────┐
│    statuses      │
│──────────────────│
│ id (PK)          │
│ child_id (FK)    │──→ children.id
│ category         │
│ value            │
│ updated_at       │
└──────────────────┘

┌──────────────────┐
│ status_history   │
│──────────────────│
│ id (PK)          │
│ child_id (FK)    │──→ children.id
│ category         │
│ value            │
│ change_amount    │
│ change_type      │  (increase / decrease / evaluation)
│ recorded_at      │
└──────────────────┘

┌──────────────────┐
│   evaluations    │
│──────────────────│
│ id (PK)          │
│ child_id (FK)    │──→ children.id
│ week_start       │
│ week_end         │
│ scores_json      │
│ bonus_points     │
│ created_at       │
└──────────────────┘

┌──────────────────────┐
│  market_benchmarks   │
│──────────────────────│
│ id (PK)              │
│ age                  │
│ category             │
│ mean                 │
│ std_dev              │
│ source               │
│ updated_at           │
└──────────────────────┘

┌──────────────────┐
│    settings      │
│──────────────────│
│ key (PK)         │
│ value            │
│ updated_at       │
└──────────────────┘

┌──────────────────────┐
│  character_images    │
│──────────────────────│
│ id (PK)              │
│ child_id (FK)        │──→ children.id
│ type                 │  (hero / normal / effort)
│ file_path            │
│ prompt_hash          │
│ generated_at         │
└──────────────────────┘

┌──────────────────────┐
│   login_bonuses      │
│──────────────────────│
│ id (PK)              │
│ child_id (FK)        │──→ children.id
│ login_date           │  (YYYY-MM-DD, UNIQUE with child_id)
│ rank                 │  (大大吉/大吉/中吉/小吉/吉/末吉)
│ base_points          │
│ multiplier           │
│ total_points         │
│ consecutive_days     │
│ created_at           │
└──────────────────────┘
```

---

## 3. テーブル定義

### children

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| id | INTEGER | NO | autoincrement | 主キー |
| nickname | TEXT | NO | - | 表示名（ひらがな） |
| age | INTEGER | NO | - | 年齢 |
| birth_date | TEXT | YES | NULL | 誕生日（YYYY-MM-DD） |
| theme | TEXT | NO | 'pink' | テーマ名 |
| created_at | TEXT | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TEXT | NO | CURRENT_TIMESTAMP | 更新日時 |

### activities

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| id | INTEGER | NO | autoincrement | 主キー |
| name | TEXT | NO | - | 活動名（ひらがな） |
| category | TEXT | NO | - | カテゴリ |
| icon | TEXT | NO | - | アイコン識別子 |
| base_points | INTEGER | NO | 5 | 基本ポイント |
| age_min | INTEGER | YES | NULL | 対象最小年齢 |
| age_max | INTEGER | YES | NULL | 対象最大年齢 |
| is_visible | INTEGER | NO | 1 | 表示フラグ (0/1) |
| daily_limit | INTEGER | YES | NULL | 1日の記録上限 |
| sort_order | INTEGER | NO | 0 | 表示順 |
| created_at | TEXT | NO | CURRENT_TIMESTAMP | 作成日時 |

### activity_logs

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| id | INTEGER | NO | autoincrement | 主キー |
| child_id | INTEGER | NO | - | FK → children.id |
| activity_id | INTEGER | NO | - | FK → activities.id |
| points | INTEGER | NO | - | 基本ポイント |
| streak_days | INTEGER | NO | 1 | 連続記録日数 |
| streak_bonus | INTEGER | NO | 0 | ストリークボーナスポイント |
| recorded_date | TEXT | NO | - | 記録日（YYYY-MM-DD） |
| recorded_at | TEXT | NO | CURRENT_TIMESTAMP | 記録日時 |
| cancelled | INTEGER | NO | 0 | キャンセル済みフラグ |

**ユニーク制約:** (child_id, activity_id, recorded_date) ※同一活動は1日1回まで

**インデックス:**
- `idx_activity_logs_child_date` ON (child_id, recorded_date)
- `idx_activity_logs_activity` ON (activity_id)
- `idx_activity_logs_streak` ON (child_id, activity_id, recorded_date)

### point_ledger

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| id | INTEGER | NO | autoincrement | 主キー |
| child_id | INTEGER | NO | - | FK → children.id |
| amount | INTEGER | NO | - | 金額（正: 獲得、負: 消費） |
| type | TEXT | NO | - | 種別: earn / spend / convert / cancel |
| description | TEXT | YES | NULL | 説明 |
| reference_id | INTEGER | YES | NULL | 関連するログID等 |
| created_at | TEXT | NO | CURRENT_TIMESTAMP | 作成日時 |

**インデックス:**
- `idx_point_ledger_child` ON (child_id, created_at)

### statuses

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| id | INTEGER | NO | autoincrement | 主キー |
| child_id | INTEGER | NO | - | FK → children.id |
| category | TEXT | NO | - | ステータスカテゴリ |
| value | REAL | NO | 0.0 | 現在値（0.0〜100.0） |
| updated_at | TEXT | NO | CURRENT_TIMESTAMP | 最終更新日時 |

**ユニーク制約:** (child_id, category)

### status_history

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| id | INTEGER | NO | autoincrement | 主キー |
| child_id | INTEGER | NO | - | FK → children.id |
| category | TEXT | NO | - | カテゴリ |
| value | REAL | NO | - | 変更後の値 |
| change_amount | REAL | NO | - | 変更量（正: 増加、負: 減少） |
| change_type | TEXT | NO | - | increase / decrease / evaluation |
| recorded_at | TEXT | NO | CURRENT_TIMESTAMP | 記録日時 |

**インデックス:**
- `idx_status_history_child_cat` ON (child_id, category, recorded_at)

### evaluations

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| id | INTEGER | NO | autoincrement | 主キー |
| child_id | INTEGER | NO | - | FK → children.id |
| week_start | TEXT | NO | - | 評価週の開始日 |
| week_end | TEXT | NO | - | 評価週の終了日 |
| scores_json | TEXT | NO | - | カテゴリ別評価スコア（JSON） |
| bonus_points | INTEGER | NO | 0 | ボーナスポイント |
| created_at | TEXT | NO | CURRENT_TIMESTAMP | 作成日時 |

**scores_json 例:**
```json
{
  "うんどう": { "count": 5, "points": 25, "statusDelta": 2.0 },
  "べんきょう": { "count": 3, "points": 15, "statusDelta": 1.0 }
}
```

### market_benchmarks

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| id | INTEGER | NO | autoincrement | 主キー |
| age | INTEGER | NO | - | 対象年齢 |
| category | TEXT | NO | - | カテゴリ |
| mean | REAL | NO | - | 平均値 |
| std_dev | REAL | NO | - | 標準偏差 |
| source | TEXT | YES | NULL | データソース |
| updated_at | TEXT | NO | CURRENT_TIMESTAMP | 更新日時 |

**ユニーク制約:** (age, category)

### settings

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| key | TEXT | NO | - | 設定キー（主キー） |
| value | TEXT | NO | - | 設定値 |
| updated_at | TEXT | NO | CURRENT_TIMESTAMP | 更新日時 |

**使用するキー:**
| key | 説明 |
|-----|------|
| pin_hash | PINコードのbcryptハッシュ |
| session_token | 現在のセッショントークン |
| session_expires_at | セッション有効期限 |
| pin_failed_attempts | PIN失敗回数 |
| pin_locked_until | ロックアウト解除時刻 |

### character_images

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| id | INTEGER | NO | autoincrement | 主キー |
| child_id | INTEGER | NO | - | FK → children.id |
| type | TEXT | NO | - | hero / normal / effort |
| file_path | TEXT | NO | - | 画像ファイルパス |
| prompt_hash | TEXT | YES | NULL | 生成プロンプトのハッシュ |
| generated_at | TEXT | NO | CURRENT_TIMESTAMP | 生成日時 |

### login_bonuses

| カラム | 型 | NULL | デフォルト | 説明 |
|--------|------|------|-----------|------|
| id | INTEGER | NO | autoincrement | 主キー |
| child_id | INTEGER | NO | - | FK → children.id |
| login_date | TEXT | NO | - | ログイン日（YYYY-MM-DD） |
| rank | TEXT | NO | - | おみくじランク |
| base_points | INTEGER | NO | - | 基本獲得ポイント |
| multiplier | REAL | NO | 1.0 | 連続ログイン倍率 |
| total_points | INTEGER | NO | - | 実際の獲得ポイント |
| consecutive_days | INTEGER | NO | 1 | 連続ログイン日数 |
| created_at | TEXT | NO | CURRENT_TIMESTAMP | 作成日時 |

**ユニーク制約:** (child_id, login_date)

**おみくじランク定義:**

| ランク | ポイント | 確率（重み） |
|--------|---------|------------|
| 大大吉 | 20 | 1% |
| 大吉 | 10 | 5% |
| 中吉 | 7 | 15% |
| 小吉 | 5 | 25% |
| 吉 | 3 | 34% |
| 末吉 | 1 | 20% |

**連続ログイン倍率:**

| 連続日数 | 倍率 |
|---------|------|
| 1-2日 | 1.0x |
| 3-6日 | 1.5x |
| 7-13日 | 2.0x |
| 14-29日 | 2.5x |
| 30日以上 | 3.0x |

---

## 4. Drizzle ORM スキーマ定義（TypeScript）

```typescript
// src/lib/server/db/schema.ts

import { sqliteTable, text, integer, real, uniqueIndex, index } from 'drizzle-orm/sqlite-core';
import { sql } from 'drizzle-orm';

export const children = sqliteTable('children', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  nickname: text('nickname').notNull(),
  age: integer('age').notNull(),
  birthDate: text('birth_date'),
  theme: text('theme').notNull().default('pink'),
  createdAt: text('created_at').notNull().default(sql`CURRENT_TIMESTAMP`),
  updatedAt: text('updated_at').notNull().default(sql`CURRENT_TIMESTAMP`),
});

export const activities = sqliteTable('activities', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  name: text('name').notNull(),
  category: text('category').notNull(),
  icon: text('icon').notNull(),
  basePoints: integer('base_points').notNull().default(5),
  ageMin: integer('age_min'),
  ageMax: integer('age_max'),
  isVisible: integer('is_visible').notNull().default(1),
  dailyLimit: integer('daily_limit'),
  sortOrder: integer('sort_order').notNull().default(0),
  createdAt: text('created_at').notNull().default(sql`CURRENT_TIMESTAMP`),
});

export const activityLogs = sqliteTable('activity_logs', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  childId: integer('child_id').notNull().references(() => children.id),
  activityId: integer('activity_id').notNull().references(() => activities.id),
  points: integer('points').notNull(),
  streakDays: integer('streak_days').notNull().default(1),
  streakBonus: integer('streak_bonus').notNull().default(0),
  recordedDate: text('recorded_date').notNull(),
  recordedAt: text('recorded_at').notNull().default(sql`CURRENT_TIMESTAMP`),
  cancelled: integer('cancelled').notNull().default(0),
}, (table) => [
  uniqueIndex('idx_activity_logs_unique_daily').on(table.childId, table.activityId, table.recordedDate),
  index('idx_activity_logs_child_date').on(table.childId, table.recordedDate),
  index('idx_activity_logs_activity').on(table.activityId),
  index('idx_activity_logs_streak').on(table.childId, table.activityId, table.recordedDate),
]);

export const pointLedger = sqliteTable('point_ledger', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  childId: integer('child_id').notNull().references(() => children.id),
  amount: integer('amount').notNull(),
  type: text('type').notNull(),
  description: text('description'),
  referenceId: integer('reference_id'),
  createdAt: text('created_at').notNull().default(sql`CURRENT_TIMESTAMP`),
}, (table) => [
  index('idx_point_ledger_child').on(table.childId, table.createdAt),
]);

export const statuses = sqliteTable('statuses', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  childId: integer('child_id').notNull().references(() => children.id),
  category: text('category').notNull(),
  value: real('value').notNull().default(0.0),
  updatedAt: text('updated_at').notNull().default(sql`CURRENT_TIMESTAMP`),
}, (table) => [
  uniqueIndex('idx_statuses_child_category').on(table.childId, table.category),
]);

export const statusHistory = sqliteTable('status_history', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  childId: integer('child_id').notNull().references(() => children.id),
  category: text('category').notNull(),
  value: real('value').notNull(),
  changeAmount: real('change_amount').notNull(),
  changeType: text('change_type').notNull(),
  recordedAt: text('recorded_at').notNull().default(sql`CURRENT_TIMESTAMP`),
}, (table) => [
  index('idx_status_history_child_cat').on(table.childId, table.category, table.recordedAt),
]);

export const evaluations = sqliteTable('evaluations', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  childId: integer('child_id').notNull().references(() => children.id),
  weekStart: text('week_start').notNull(),
  weekEnd: text('week_end').notNull(),
  scoresJson: text('scores_json').notNull(),
  bonusPoints: integer('bonus_points').notNull().default(0),
  createdAt: text('created_at').notNull().default(sql`CURRENT_TIMESTAMP`),
});

export const marketBenchmarks = sqliteTable('market_benchmarks', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  age: integer('age').notNull(),
  category: text('category').notNull(),
  mean: real('mean').notNull(),
  stdDev: real('std_dev').notNull(),
  source: text('source'),
  updatedAt: text('updated_at').notNull().default(sql`CURRENT_TIMESTAMP`),
}, (table) => [
  uniqueIndex('idx_benchmarks_age_category').on(table.age, table.category),
]);

export const settings = sqliteTable('settings', {
  key: text('key').primaryKey(),
  value: text('value').notNull(),
  updatedAt: text('updated_at').notNull().default(sql`CURRENT_TIMESTAMP`),
});

export const characterImages = sqliteTable('character_images', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  childId: integer('child_id').notNull().references(() => children.id),
  type: text('type').notNull(),
  filePath: text('file_path').notNull(),
  promptHash: text('prompt_hash'),
  generatedAt: text('generated_at').notNull().default(sql`CURRENT_TIMESTAMP`),
});

export const loginBonuses = sqliteTable('login_bonuses', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  childId: integer('child_id').notNull().references(() => children.id),
  loginDate: text('login_date').notNull(),
  rank: text('rank').notNull(),
  basePoints: integer('base_points').notNull(),
  multiplier: real('multiplier').notNull().default(1.0),
  totalPoints: integer('total_points').notNull(),
  consecutiveDays: integer('consecutive_days').notNull().default(1),
  createdAt: text('created_at').notNull().default(sql`CURRENT_TIMESTAMP`),
}, (table) => [
  uniqueIndex('idx_login_bonuses_child_date').on(table.childId, table.loginDate),
]);
```

---

## 5. シードデータ

### 初期子供データ

```sql
INSERT INTO children (nickname, age, theme) VALUES
  ('おじょうさま', 4, 'pink');
-- 坊ちゃまは成長後に追加
```

### 初期活動マスタ

要件定義書 §8 の初期活動リスト15件を投入。

### 初期市場ベンチマーク（4歳児・暫定値）

```sql
INSERT INTO market_benchmarks (age, category, mean, std_dev, source) VALUES
  (4, 'うんどう', 30.0, 10.0, '暫定値'),
  (4, 'べんきょう', 20.0, 8.0, '暫定値'),
  (4, 'おてつだい', 25.0, 9.0, '暫定値'),
  (4, 'コミュニケーション', 25.0, 10.0, '暫定値'),
  (4, 'せいかつ', 35.0, 8.0, '暫定値');
```

### 初期ステータス（4歳児・一般平均値で初期化）

```sql
INSERT INTO statuses (child_id, category, value) VALUES
  (1, 'うんどう', 30.0),
  (1, 'べんきょう', 20.0),
  (1, 'おてつだい', 25.0),
  (1, 'コミュニケーション', 25.0),
  (1, 'せいかつ', 35.0);
```

---

## 6. バックアップ方針

| 項目 | 内容 |
|------|------|
| 方式 | SQLiteファイルを日次でgit commit + push |
| タイミング | 毎日 3:00 AM（タスクスケジューラ） |
| 保存先 | GitHub プライベートリポジトリ |
| 保持期間 | Git履歴により永久保持 |
| 復旧手順 | git clone → DBファイル配置 → サービス起動 |

### バックアップスクリプト（参考）

```bash
#!/bin/bash
DB_PATH="/path/to/ganbari-quest.db"
BACKUP_REPO="/path/to/backup-repo"

cp "$DB_PATH" "$BACKUP_REPO/ganbari-quest.db"
cd "$BACKUP_REPO"
git add ganbari-quest.db
git commit -m "backup: $(date +%Y-%m-%d_%H:%M)"
git push origin main
```
