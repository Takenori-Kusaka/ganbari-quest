# ログインボーナス実装

### ステータス

`Done`

### GitHub Copilot 対応: 部分的に可能

> API/サービス層の実装はCopilot対応可能。おみくじの確率ロジック、倍率計算はCopilot可能。UI演出部分（おみくじアニメーション）はClaude Codeが設計。

---

### 概要

子供がアプリにアクセスした際、1日1回おみくじ形式でボーナスポイントを付与するログインボーナス機能を実装する。

### 背景・動機

毎日のアプリ利用を動機付けるため、ガチャ/おみくじ的な射幸心を煽るゲーミフィケーション要素を導入する。連続ログインで倍率が上がる仕組みにより、継続利用も促進する。

### ゴール

- [x] `login_bonuses` テーブル（DBスキーマ - #0011で作成済み）
- [x] `src/routes/api/v1/login-bonus/[childId]/+server.ts` (GET)
- [x] `src/routes/api/v1/login-bonus/[childId]/claim/+server.ts` (POST)
- [x] `$lib/server/services/login-bonus-service.ts`
  - [x] おみくじランク抽選ロジック（重み付きランダム: 大大吉1%, 大吉5%, 中吉15%, 小吉25%, 吉34%, 末吉20%）
  - [x] 連続ログイン日数計算
  - [x] 連続ログイン倍率適用（3日:1.5x, 7日:2.0x, 14日:2.5x, 30日:3.0x）
  - [x] ALREADY_CLAIMED エラー処理
- [x] `$lib/server/db/login-bonus-repo.ts`
- [x] `$lib/domain/validation/login-bonus.ts`（ドメインロジック）
- [ ] 子供用ホーム画面でのおみくじ演出（#0017 フロント実装で対応）
- [x] ユニットテスト（19件全パス）
- [ ] 統合テスト（API-LB-01〜04）— フロント実装時に追加
- [ ] E2Eテスト（E2E-09）— フロント実装時に追加

### 作業メモ

- おみくじ確率: 大大吉1%, 大吉5%, 中吉15%, 小吉25%, 吉34%, 末吉20%（合計100%）
- `point_ledger` にも `login_bonus` タイプで記録済み
- ホーム画面のload関数で当日受取状態をチェックし、未受取ならおみくじ表示

### 成果・結果

- おみくじ抽選ロジック（6ランク、重み付きランダム）
- 連続ログイン日数計算・倍率適用
- ログインボーナス状態取得/受取API
- ポイント台帳連携
- テスト215件全パス（うちログインボーナス関連19件）

### 残課題・次のアクション

- UI演出（おみくじアニメーション）は #0017 で実装
- 特別日ボーナス（誕生日、祝日等）は将来検討
