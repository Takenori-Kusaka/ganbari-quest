# 活動記録API実装

### ステータス

`Done`

### GitHub Copilot 対応: 可能

> API設計書を入力として、+server.ts / サービス層 / リポジトリ層の実装はCopilot対応可能

---

### 概要

活動記録の CRUD API を実装する。

### 背景・動機

子供が活動を記録し、履歴を確認するための基盤API。

### ゴール

- [x] `src/routes/api/v1/activities/+server.ts` (GET, POST)
- [x] `src/routes/api/v1/activities/[id]/+server.ts` (GET, PATCH, DELETE)
- [x] `src/routes/api/v1/activities/[id]/visibility/+server.ts` (PATCH)
- [x] `src/routes/api/v1/activity-logs/+server.ts` (GET, POST)
- [x] `src/routes/api/v1/activity-logs/[id]/+server.ts` (DELETE)
- [x] `$lib/server/services/activity-service.ts`
- [x] `$lib/server/services/activity-log-service.ts`
- [x] `$lib/server/db/activity-repo.ts`
- [x] Zod バリデーションスキーマ (`$lib/domain/validation/activity.ts`)
- [x] **1日1回制限**: 同じ活動は同日に1回のみ記録可能（UNIQUE制約 + サービス層チェック）
- [x] **ストリークボーナス**: 前日に同活動を記録していた場合、連続日数をカウントし `min(連続日数-1, 10)` の追加ポイントを付与
- [x] **ALREADY_RECORDED エラー (409)**: 同日重複時に返却
- [x] ユニットテスト（calcStreakBonus, 日次制限, ストリーク, キャンセル, ポイント台帳 — 15テスト）
- [ ] 統合テスト（API-LOG-01〜07）— フロントエンド実装時に追加予定

### 作業メモ

- 活動記録のキャンセル（DELETE）は5秒以内のみ可能
- 子供別にフィルタリング可能であること
- `recorded_date` カラム（YYYY-MM-DD）で日次ユニーク制約を実現
- ストリーク計算: activity_logsテーブルから前日のrecorded_dateで同activity_idを検索
- レスポンスに `streakDays`, `streakBonus`, `totalPoints` を含める

### 成果・結果

- 活動CRUD API 5エンドポイント実装
- 活動記録API（記録・取得・キャンセル）3エンドポイント実装
- サービス層（activity-service, activity-log-service）実装
- リポジトリ層（activity-repo）実装
- Zod バリデーションスキーマ実装
- ユニットテスト 15件（全パス）
- npm run check: 0エラー、npm run build: 成功

### 残課題・次のアクション

- 統合テスト（E2E）はフロントエンド実装後に追加

